/*******************************************************************************
*  skI2Clib - ??????????                                             *
*             ????????I2C????(RTC/EEPROM?)???????????  *
*                                                                              *
*    InterI2C       - ????????????                                 *
*    InitI2C_Master - ??????????????????????             *
*    I2C_Start      - ???????????????????????           *
*    I2C_rStart     - ???????????????????????????? *
*    I2C_Stop       - ???????????????????????           *
*    I2C_Send       - ???????????????????                   *
*    I2C_Receive    - ????????????????????                 *
*                                                                              *
*    ???SDA/SCL??????????????????????????         *
*          ???????100/400KHz(CPU8MHz)????????                   *
*          ??????????????????????"I2C_Start"?????? *
*          SSP2?????????skI2Clib.h?"#define I2C_MSSP2_USE"????? *
* ============================================================================ *
*  VERSION DATE        BY                    CHANGE/COMMENT                    *
* ---------------------------------------------------------------------------- *
*  1.00    2012-01-20  ?????(????)  Create                            *
*  1.01    2013-02-16  ?????(????)  XC8 C Compiler ?????         *
*  2.00    2014-11-01  ?????(????)  ??????????              *
*  2.10    2015-03-04  ?????(????)  ????100/400KHz??????    *
*  3.00    2015-04-20  ?????(????)  SSP1/SSP2???16F193x???      *
* ============================================================================ *
*  PIC 12F1822 16F18xx 16F193x 18F25K22                                        *
*  MPLAB IDE(V8.63) MPLAB X(v2.15)                                             *
*  MPLAB(R) XC8 C Compiler Version 1.00/1.32                                   *
*******************************************************************************/
#include <xc.h>
#include "skI2Clib.h"

int AckCheck ;           // ?????ACK????????
int CollisionCheck ;     // ????????????????????

// ???????????
// ACKEN RCEN PEN RSEN SEN R/W BF ????????
void I2C_IdleCheck(char mask)
{
     while (( I2C_SSPCON2 & 0x1F ) | (I2C_SSPSTAT & mask)) ;
}
/*******************************************************************************
*  InterI2C( void )                                                            *
*    ????????????                                                  *
*     ????????????????????????                         *
*******************************************************************************/
void InterI2C( void )
{
     if (I2C_SSPIF == 1) {       // SSP(I2C)????????
          if (AckCheck == 1) AckCheck = 0 ;
          I2C_SSPIF = 0 ;        // ??????
     }
     if (I2C_BCLIF == 1) {       // MSSP(I2C)????????????
          CollisionCheck = 1 ;
          I2C_BCLIF = 0 ;        // ??????
     }
}
/*******************************************************************************
*  InitI2C_Master(speed)                                                       *
*    ??????????????????????                              *
*                                                                              *
*    speed : I2C????????(0=100KHz 1=400KHz)                            *
*                                                                              *
*    ?)????8MHz??????????????SSPADD???????????? *
*             4MHz  8MHz  16MHz  32MHz  40MHz  48MHz                           *
*    100KHz   0x09  0x13   0x27   0x4F   0x63   0x77                           *
*    400kHz         0x04   0x09   0x13   0x18   0x1D                           *
*******************************************************************************/
void InitI2C_Master(int speed)
{
     I2C_SSPSTAT= 0b10000000 ;     // ????????????(100kHz/1MHz)
     I2C_SSPCON1= 0b00101000 ;     // SDA/SCL???I2C???????????????
     if (speed == 0) {
          I2C_SSPADD = 0x13       ;   // ????=FOSC/((SSPADD + 1)*4) 8MHz/((0x13+1)*4)=0.1(100KHz)
     } else {
          I2C_SSPADD = 0x04       ;   // ????=FOSC/((SSPADD + 1)*4) 8MHz/((0x04+1)*4)=0.4(400KHz)
          I2C_SSPSTAT_SMP = 0 ;       // ????????????(400kHz)
     }
     I2C_SSPIE = 1 ;               // SSP(I2C)?????????
     I2C_BCLIE = 1 ;               // MSSP(I2C)?????????????
     PEIE      = 1 ;               // ?????????????
     GIE       = 1 ;               // ????????????
     I2C_SSPIF = 0 ;               // SSP(I2C)?????????????
     I2C_BCLIF = 0 ;               // MSSP(I2C)?????????????????
}
/*******************************************************************************
*  ans = I2C_Start(adrs,rw)                                                    *
*    ???????????????????????                            *
*                                                                              *
*    adrs : ???????????????                                     *
*    rw   : ?????????????????                                 *
*           0=??????????????1=?????????????         *
*    ans  : 0=??                                                             *
*           1=??(????ACK???????) -1=??????????????  *
*******************************************************************************/
int I2C_Start(int adrs,int rw)
{
     CollisionCheck = 0 ;
     // ????(START CONDITION)
     I2C_IdleCheck(0x5) ;
     I2C_SSPCON2_SEN = 1 ;
     // [?????????]?????
     I2C_IdleCheck(0x5) ;
     if (CollisionCheck == 1) return -1 ;
     AckCheck = 1 ;
     I2C_SSPBUF = (char)((adrs<<1)+rw) ;     // ???? + R/W???
     while (AckCheck) ;                      // ?????ACK?????
     if (CollisionCheck == 1) return -1 ;
     return I2C_SSPCON2_ACKSTAT ;
}
/*******************************************************************************
*  ans = I2C_rStart(adrs,rw)                                                   *
*    ????????????????????????????                  *
*                                                                              *
*    adrs : ???????????????                                     *
*    rw   : ?????????????????                                 *
*           0=??????????????1=?????????????         *
*    ans  : 0=??                                                             *
*           1=??(????ACK???????) -1=??????????????  *
*******************************************************************************/
int I2C_rStart(int adrs,int rw)
{
     CollisionCheck = 0 ;
     // ?????????(REPEATED START CONDITION)
     I2C_IdleCheck(0x5) ;
     I2C_SSPCON2_RSEN = 1 ;
     // [?????????]?????
     I2C_IdleCheck(0x5) ;
     if (CollisionCheck == 1) return -1 ;
     AckCheck = 1 ;
     I2C_SSPBUF = (char)((adrs<<1)+rw) ;     // ???? + R/W???
     while (AckCheck) ;                      // ?????ACK?????
     if (CollisionCheck == 1) return -1 ;
     return I2C_SSPCON2_ACKSTAT ;
}
/*******************************************************************************
*  ans = I2C_Stop()                                                            *
*    ???????????????????????                            *
*    ans  :  0=??                                                            *
*           -1=??????????????                                    *
*******************************************************************************/
int I2C_Stop()
{
     CollisionCheck = 0 ;
     // ????(STOP CONDITION)
     I2C_IdleCheck(0x5) ;
     I2C_SSPCON2_PEN = 1 ;
     if (CollisionCheck == 1) return -1 ;
     else                     return  0 ;
}
/*******************************************************************************
*  ans = I2C_Send(dt)                                                          *
*    ???????????????????                                    *
*                                                                              *
*    dt  : ?????????????                                          *
*    ans  : 0=??                                                             *
*           1=??(????ACK?????????NOACK????)                 *
*          -1=??????????????                                     *
*******************************************************************************/
int I2C_Send(char dt)
{
     CollisionCheck = 0 ;
     I2C_IdleCheck(0x5) ;
     if (CollisionCheck == 1) return -1 ;
     AckCheck = 1 ;
     I2C_SSPBUF = dt ;                  // ??????
     while (AckCheck) ;                 // ?????ACK?????
     if (CollisionCheck == 1) return -1 ;
     return I2C_SSPCON2_ACKSTAT ;
}
/*******************************************************************************
*  ans = I2C_Receive(ack)                                                      *
*    ????????????????????                                  *
*                                                                              *
*    ack  : ?????????????????                                 *
*           0:ACK????1:NOACK???(??????????1)                  *
*    ans  : ??????????                                               *
*           -1=??????????????                                    *
*******************************************************************************/
int I2C_Receive(int ack)
{
     int dt ;

     CollisionCheck = 0 ;
     I2C_IdleCheck(0x5) ;
     I2C_SSPCON2_RCEN = 1 ;           // ???????
     I2C_IdleCheck(0x4) ;
     if (CollisionCheck == 1) return -1 ;
     dt = I2C_SSPBUF ;                // ??????
     I2C_IdleCheck(0x5) ;
     if (CollisionCheck == 1) return -1 ;
     I2C_SSPCON2_ACKDT = ack ;        // ACK???????
     I2C_SSPCON2_ACKEN = 1 ;          // ACK??????
     return dt ;
}

